using System;
using System.Collections.Generic;
using System.Globalization;
using System.IO;
using System.Net;
using System.Text;
using System.Text.RegularExpressions;

namespace json_rpc
{
    class Program
    {
        /// <summary>
        /// API 参考：http://docs.neo.org/zh-cn/node/api.html
        /// API Reference: http://docs.neo.org/en-us/node/api.html
        /// </summary>
        /// <param name="args"></param>
        static void Main(string[] args)
        {
            //SendAsset();
            //SendRawTransaction();
            QueryAvailableBalance();
        }

        public static void QueryAvailableBalance()
        {

            string paramter = "{'jsonrpc': '2.0', 'method': 'invokescript', 'params': ['14cc82a87f5693c363cd64674024f30a603788134551c1157175657279417661696c61626c6542616c616e63656773031a8b41f8605a281e209249c3bc219522bc7b'],  'id': 1}";
            var r = PostWebRequest("http://localhost:10332", paramter);
            Console.WriteLine(ToGB2312(r));
            var json = batchRpc.MyJson.Parse(ToGB2312(r)).AsDict();
            var value = json["result"].AsDict()["stack"].GetArrayItem(0).GetDictItem("value");
            Console.WriteLine("value: " + value);
            Console.ReadLine();
        }

        public static void SendRawTransaction()
        {

            string paramter = "{'jsonrpc': '2.0', 'method': 'sendrawtransaction', 'params': ['d1013514410cd5236d22426ba9412475dfe2eba594fbc3c751c108776974686472617767ebd3524293d7f3f8551403b335cf4ee66926637300000000000000000120ebd3524293d7f3f8551403b335cf4ee66926637300000106000430323135fd7a10011ec56b6c766b00527ac46c766b51527ac4616168164e656f2e52756e74696d652e47657454726967676572009c6c766b52527ac46c766b52c3648702616114666f6214f9d89e423d2c40cbdd3a2bf9d949761b6168184e656f2e52756e74696d652e436865636b5769746e6573736c766b56527ac46c766b56c3640e00516c766b57527ac462890661682953797374656d2e457865637574696f6e456e67696e652e476574536372697074436f6e7461696e65726c766b53527ac46c766b53c36168174e656f2e5472616e73616374696f6e2e476574547970656c766b54527ac46c766b54c36102d1009c009c6c766b58527ac46c766b58c3640e00006c766b57527ac4620a066c766b53c36c766b55527ac46c766b55c36168234e656f2e496e766f636174696f6e5472616e73616374696f6e2e476574536372697074c001359c009c6c766b59527ac46c766b59c3644f00612c696e766f636174696f6e5472616e73616374696f6e2e5363726970742e4c656e67746820696c6c6567616c2161680f4e656f2e52756e74696d652e4c6f6761006c766b57527ac46272056c766b55c36168234e656f2e496e766f636174696f6e5472616e73616374696f6e2e47657453637269707400517f01149c009c6c766b5a527ac46c766b5ac3640e00006c766b57527ac46225056c766b55c36168234e656f2e496e766f636174696f6e5472616e73616374696f6e2e476574536372697074011501207f0351c1080877697468647261777e01677e61682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173687e9c009c6c766b5b527ac46c766b5bc36448006125696e766f636174696f6e5472616e73616374696f6e2e53637269707420696c6c6567616c2161680f4e656f2e52756e74696d652e4c6f6761006c766b57527ac4625c04516c766b57527ac46251046168164e656f2e52756e74696d652e47657454726967676572609c6c766b5c527ac46c766b5cc3641c04616c766b00c3066465706c6f79876c766b5d527ac46c766b5dc3649900616114666f6214f9d89e423d2c40cbdd3a2bf9d949761b6168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b5e527ac46c766b5ec3640e00006c766b57527ac462bc036168164e656f2e53746f726167652e476574436f6e746578740d61697264726f70537570706c7900615272680f4e656f2e53746f726167652e50757461516c766b57527ac46274036c766b00c3076465706f736974876c766b5f527ac46c766b5fc3641700616c766b51c3616556036c766b57527ac46243036c766b00c3087769746864726177876c766b60527ac46c766b60c3644d00616c766b51c3c0519c009c6c766b0112527ac46c766b0112c3640e00006c766b57527ac462fe026c766b51c300c36c766b0111527ac46c766b0111c36165e3046c766b57527ac462db026c766b00c312717565727941697244726f70537570706c79876c766b0113527ac46c766b0113c3644800616168164e656f2e53746f726167652e476574436f6e746578740d61697264726f70537570706c79617c680f4e656f2e53746f726167652e4765746c766b57527ac4626c026c766b00c313717565727941697244726f7042616c616e6365876c766b0114527ac46c766b0114c3647500616c766b51c3c0519c009c6c766b0116527ac46c766b0116c3640e00006c766b57527ac4621a026c766b51c300c36c766b0115527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b0115c3617c680f4e656f2e53746f726167652e4765746c766b57527ac462cf016c766b00c3157175657279417661696c61626c6542616c616e6365876c766b0117527ac46c766b0117c3644d00616c766b51c3c0519c009c6c766b0119527ac46c766b0119c3640e00006c766b57527ac4627b016c766b51c300c36c766b0118527ac46c766b0118c361653a0a6c766b57527ac46258016c766b00c3117365745769746864726177537769746368876c766b011a527ac46c766b011ac3642301616114666f6214f9d89e423d2c40cbdd3a2bf9d949761b6168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b011b527ac46c766b011bc3640e00006c766b57527ac462df006c766b51c3c0519c009c6c766b011c527ac46c766b011cc3640e00006c766b57527ac462b9006c766b51c300c3026f6e876c766b011d527ac46c766b011dc3644600616168164e656f2e53746f726167652e476574436f6e746578740e576974686472617753776974636851615272680f4e656f2e53746f726167652e5075746161624300616168164e656f2e53746f726167652e476574436f6e746578740e576974686472617753776974636800615272680f4e656f2e53746f726167652e5075746161516c766b57527ac4620f0061006c766b57527ac46203006c766b57c3616c75665ac56b6c766b00527ac4616114666f6214f9d89e423d2c40cbdd3a2bf9d949761b6168184e656f2e52756e74696d652e436865636b5769746e657373009c6c766b54527ac46c766b54c3640e00006c766b55527ac46297016c766b00c3c0529c009c6c766b56527ac46c766b56c3640e00006c766b55527ac46273016c766b00c300c36c766b51527ac46c766b51c3c001149c009c6c766b57527ac46c766b57c3640e00006c766b55527ac46240016c766b00c351c36c766b52527ac46c766b52c300a16314006c766b52c3070031cae8a0e909a0620400516c766b58527ac46c766b58c3640e00006c766b55527ac462fc006168164e656f2e53746f726167652e476574436f6e746578740d61697264726f70537570706c79617c680f4e656f2e53746f726167652e4765746c766b53527ac46c766b53c36c766b52c3930700935ebae2bc1da06c766b59527ac46c766b59c3640e00006c766b55527ac4628d006168164e656f2e53746f726167652e476574436f6e746578746c766b51c36c766b52c3615272680f4e656f2e53746f726167652e507574616168164e656f2e53746f726167652e476574436f6e746578740d61697264726f70537570706c796c766b53c36c766b52c393615272680f4e656f2e53746f726167652e50757461516c766b55527ac46203006c766b55c3616c75660114c56b6c766b00527ac4616168164e656f2e53746f726167652e476574436f6e746578740e5769746864726177537769746368617c680f4e656f2e53746f726167652e4765746c766b51527ac46c766b51c3009c6c766b59527ac46c766b59c3640e00006c766b5a527ac462e1036c766b00c3610a66697273745068617365617c65d4036c766b52527ac46c766b00c3610b7365636f6e645068617365617c65b6036c766b53527ac46c766b00c3610a74686972645068617365617c6599036c766b54527ac46c766b52c36c766b53c3936c766b54c3936c766b55527ac46c766b55c3519f6c766b5b527ac46c766b5bc3640e00006c766b5a527ac462500361682d53797374656d2e457865637574696f6e456e67696e652e476574457865637574696e67536372697074486173686c766b56527ac4087472616e7366657253c576006c766b56c3c476516c766b00c3c476526c766b55c3c4617c675f89105fdcf8b97739c68f3e969d60b6e98bfa066c766b57527ac46c766b57c3519c6c766b58527ac46c766b58c36c766b5c527ac46c766b5cc364ab02616c766b52c300a06c766b5e527ac46c766b5ec3648800616168164e656f2e53746f726167652e476574436f6e74657874610a666972737450686173656c766b00c37e617c680f4e656f2e53746f726167652e4765746c766b5f527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b00c36c766b5fc36c766b52c394615272680f4e656f2e53746f726167652e50757461616c766b53c300a06c766b60527ac46c766b60c3648b00616168164e656f2e53746f726167652e476574436f6e74657874610b7365636f6e6450686173656c766b00c37e617c680f4e656f2e53746f726167652e4765746c766b0111527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b00c36c766b0111c36c766b53c394615272680f4e656f2e53746f726167652e50757461616c766b54c300a06c766b0112527ac46c766b0112c3648a00616168164e656f2e53746f726167652e476574436f6e74657874610a746869726450686173656c766b00c37e617c680f4e656f2e53746f726167652e4765746c766b0113527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b00c36c766b0113c36c766b54c394615272680f4e656f2e53746f726167652e50757461616168184e656f2e426c6f636b636861696e2e4765744865696768746168184e656f2e426c6f636b636861696e2e4765744865616465726168174e656f2e4865616465722e47657454696d657374616d706c766b5d527ac46168164e656f2e53746f726167652e476574436f6e746578746c766b00c3106c617374576974686472617754696d657e6c766b5dc3615272680f4e656f2e53746f726167652e50757461616c766b00c36c766b55c3617c08776974686472617753c168124e656f2e52756e74696d652e4e6f746966796161516c766b5a527ac46203006c766b5ac3616c75660111c56b6c766b00527ac46c766b51527ac4616c766b00c3c001149c009c6c766b59527ac46c766b59c3640e00006c766b5a527ac46246026168164e656f2e53746f726167652e476574436f6e746578746c766b51c36c766b00c37e617c680f4e656f2e53746f726167652e4765746c766b52527ac46c766b52c3519f6c766b5b527ac46c766b5bc3640e00006c766b5a527ac462e7016168184e656f2e426c6f636b636861696e2e4765744865696768746168184e656f2e426c6f636b636861696e2e4765744865616465726168174e656f2e4865616465722e47657454696d657374616d706c766b53527ac46c766b53c3048083ec5a9f6c766b5c527ac46c766b5cc3640e00006c766b5a527ac4626b016168164e656f2e53746f726167652e476574436f6e746578746c766b00c3106c617374576974686472617754696d657e617c680f4e656f2e53746f726167652e4765746c766b54527ac4006c766b55527ac4006c766b56527ac4006c766b57527ac46c766b51c3610a666972737450686173659c6c766b5d527ac46c766b5dc364110061048083ec5a6c766b57527ac4616c766b51c3610b7365636f6e6450686173659c6c766b5e527ac46c766b5ec3641100610400ac8e5b6c766b57527ac4616c766b51c3610a746869726450686173659c6c766b5f527ac46c766b5fc364110061048017df5b6c766b57527ac4616c766b54c3048083ec5aa06c766b60527ac46c766b60c3642100616c766b53c36c766b54c394038051019651936c766b55527ac461621e00616c766b53c36c766b57c394038051019651936c766b55527ac4616c766b52c36c766b55c39502da02966c766b58527ac46c766b58c36c766b5a527ac46203006c766b5ac3616c756656c56b6c766b00527ac4616c766b00c3610a66697273745068617365617c655efd6c766b51527ac46c766b00c3610b7365636f6e645068617365617c6540fd6c766b52527ac46c766b00c3610a74686972645068617365617c6523fd6c766b53527ac46c766b51c36c766b52c3936c766b53c3936c766b54527ac46c766b54c36c766b55527ac46203006c766b55c3616c7566'],  'id': 1}";
            var r = PostWebRequest("http://localhost:10332", paramter);
            Console.WriteLine(ToGB2312(r));
            var json = batchRpc.MyJson.Parse(ToGB2312(r)).AsDict();
            var txid = json["result"].AsDict()["txid"].ToString();
            if (txid.Length != 66)
            {
                Console.WriteLine(paramter);
                Console.ReadLine();
                throw new Exception();
            }
            Console.WriteLine("Txid: " + txid);
        }


        public static void SendAsset()
        {
            List<string> outputs = new List<string>();
            int total = 0;
            try
            {
                List<string> inputs = readFileToList("inputs206.txt");

                string front = "{'jsonrpc': '2.0', 'method': '', 'params': ['0x06fa8be9b6609d963e8fc63977b9f8dc5f10895f', '";
                string middle = "', ";
                string last = "],  'id': 1} ";
                foreach (string input in inputs)
                {
                    int amount = Convert.ToInt32(input.Substring(35));
                    string addr = input.Substring(0, 34);
                    string paramter = front + addr + middle + amount + last;
                    Console.WriteLine(amount);
                    Console.WriteLine(input);
                    Console.WriteLine(paramter);
                    total += amount;
                    var r = PostWebRequest("http://localhost:10332", paramter);
                    var json = batchRpc.MyJson.Parse(ToGB2312(r)).AsDict();
                    var txid = json["result"].AsDict()["txid"].ToString();
                    if (txid.Length != 66)
                    {
                        writeListToFile(outputs, "outputs206.txt");
                        Console.WriteLine(total);
                        Console.ReadLine();
                        throw new Exception();
                    }
                    Console.WriteLine(txid.ToString());
                    string output = addr + "  " + amount + "  " + txid;
                    outputs.Add(output);
                }
                writeListToFile(outputs, "outputs206.txt");
                Console.WriteLine(total);
                Console.ReadLine();
            }
            catch
            {
                writeListToFile(outputs, "outputs206.txt");
                Console.WriteLine(total);
                Console.WriteLine("Exception!");
                Console.ReadLine();
            }
        }

        public static string PostWebRequest(string postUrl, string paramData)
        {
            try
            {
                byte[] byteArray = Encoding.UTF8.GetBytes(paramData);
                WebRequest webReq = WebRequest.Create(postUrl);
                webReq.Method = "POST";
                using (Stream newStream = webReq.GetRequestStream())
                {
                    newStream.Write(byteArray, 0, byteArray.Length);
                }
                using (WebResponse response = webReq.GetResponse())
                {
                    using (StreamReader sr = new StreamReader(response.GetResponseStream(), Encoding.UTF8))
                    {
                        return sr.ReadToEnd();
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
            }
            return "";
        }


        public static string ToGB2312(string str)
        {
            MatchCollection mc = Regex.Matches(str, @"\\u([\w]{2})([\w]{2})", RegexOptions.Compiled | RegexOptions.IgnoreCase);
            byte[] bts = new byte[2];
            foreach (Match m in mc)
            {
                bts[0] = (byte)int.Parse(m.Groups[2].Value, NumberStyles.HexNumber);
                bts[1] = (byte)int.Parse(m.Groups[1].Value, NumberStyles.HexNumber);
                str = str.Replace(m.ToString(), Encoding.Unicode.GetString(bts));
            }
            return str;
        }


        public static List<string> readFileToList(string fileName)
        {
            FileStream fs = new FileStream(fileName, FileMode.Open, FileAccess.Read);
            List<string> list = new List<string>();
            StreamReader m_streamReader = new StreamReader(fs);//中文乱码加上System.Text.Encoding.Default,或则 System.Text.Encoding.GetEncoding("GB2312")
            //使用StreamReader类来读取文件
            m_streamReader.BaseStream.Seek(0, SeekOrigin.Begin);
            // 从数据流中读取每一行，直到文件的最后一行
            string strLine = m_streamReader.ReadLine();
            while (strLine != null)
            {
                list.Add(strLine);
                strLine = m_streamReader.ReadLine();
            }
            //关闭此StreamReader对象
            m_streamReader.Close();
            return list;
        }


        public static void writeListToFile(List<string> pList, string myFileName)
        {
            if (File.Exists(myFileName))
            {
                try
                {
                    File.Delete(myFileName);
                }
                finally { };
            }
            //创建一个文件流，用以写入或者创建一个StreamWriter
            System.IO.FileStream fs = new System.IO.FileStream(myFileName, FileMode.OpenOrCreate, FileAccess.Write);
            StreamWriter m_streamWriter = new StreamWriter(fs);
            m_streamWriter.Flush();
            // 使用StreamWriter来往文件中写入内容
            m_streamWriter.BaseStream.Seek(0, SeekOrigin.Begin);
            // 写入文件
            for (int i = 0; i < pList.Count; i++)
            {
                m_streamWriter.WriteLine(pList[i]);
            }
            //关闭此文件
            m_streamWriter.Flush();
            m_streamWriter.Close();
        }
    }
}
